<%# Prepare markers data for the map grouped by day %>
<%
  items_by_date = @itinerary.itinerary_items.includes(activity_item: { image_attachment: :blob }).order(:date, :time).group_by(&:date)
  days_data = items_by_date.map.with_index do |(date, items), day_index|
    {
      day: day_index + 1,
      date: date&.strftime("%d %B %Y"),
      markers: items.map.with_index do |item, index|
        {
          lat: item.activity_item.latitude,
          lng: item.activity_item.longitude,
          name: item.activity_item.name,
          type: item.activity_item.activity_type&.titleize,
          address: item.activity_item.address,
          image: item.activity_item.image.attached? ? url_for(item.activity_item.image) : nil,
          position: index + 1
        }
      end
    }
  end
%>

<div class="itineraries-show" id="top" data-controller="map" data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>" data-map-days-value="<%= days_data.to_json %>" data-map-trip-id-value="<%= @trip.id %>">
  <div class="itineraries-show__container">
      <%# Renvois vers la page my trips %>
      <%= link_to trips_path, class: "secondary-title back-link" do %>
        ← Back to my trips
      <% end %>
    <div class="itinerary-card__section">
      <div>
      <%# Fais apparaitre le nom du trip %>
        <h1 class="trip-card__title">Itinerary for "<%= @trip.name %>"</h1>
        <% days_until_trip = @trip.start_date ? (@trip.start_date - Date.today).to_i : 0 %>
        <div class="trip-card__tag" style="right: 27px">
          <%= days_until_trip > 0 ? "In #{days_until_trip} days" : "Let's go !" %>
        </div>
      </div>
      <%# Affiche la destination et la date du trip (format: "26 September 2026") %>
      <p class="secondary-title"><%= @trip.destination %> - <%= @trip.start_date.strftime("%d %B") if @trip.start_date %> to <%= @trip.end_date.strftime("%d %B %Y") if @trip.end_date %></p>
      <p class="itinerary-card__section-title">Participants</p>
        <div class="trip-card__section-avatars-wrapper">
          <div class="trip-card__section-avatars">
            <% @trip.users.each do |user| %>
              <div class="trip-card__avatar">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
          <button type="button" class="btn-map" data-action="click->map#open">
            <i class="fa-solid fa-map-location-dot"></i>
            View on map
          </button>
        </div>
      </div>

    <%# Map Modal %>
    <%= render "map_itinerary" %>
      <%# render itinerary_card %>
      <%= render "itinerary_card", itinerary: @itinerary %>
      <%# fin du render  %>
    </div>
  </div>

  <%# Scroll to top button %>
  <%= link_to "#top", class: "scroll-to-top", title: "Back to top" do %>
    ↑
  <% end %>
</div>
