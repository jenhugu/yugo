<div id="trip_card_<%= trip.user_trip_statuses.find_by(user: current_user)&.id %>" class="trip-card">
  <div class="trip-card__image">
    <%# TODO: REFACTO - Replace with dynamic image when image_url column is added to trips table %>
    <%= image_tag "paris-trip.jpg", alt: trip.name %>
    <% if trip.start_date %>
      <% days_until_trip = (trip.start_date - Date.today).to_i %>
      <div class="trip-card__tag" style="left: 27px">
        <%= days_until_trip > 0 ? "In #{days_until_trip} days" : "Let's go!" %>
      </div>
    <% end %>
  </div>

  <div class="trip-card__content">
    <div class="trip-card__header">
      <div>
        <h2 class="trip-card__title"><%= trip.name %></h2>
        <p class="trip-card__dates">
          <%= trip.destination %> - <%= trip.start_date.strftime("%b %d") if trip.start_date %> to <%= trip.end_date.strftime("%b %d, %Y") if trip.end_date %>
        </p>
      </div>
      <div class="trip-card__avatar" title="<%= trip.creator&.first_name.presence || trip.creator&.email %>">
        <%= render "shared/avatar", user: trip.creator %>
      </div>
    </div>

    <% if trip.votes_match? %>
      <%# CAS A : Votes en accord - Afficher section Participants + zone animation + bouton Discover Itinerary %>
      <div class="trip-card__section trip-card__section--full-width">
        <div class="trip-card__section-title">
          Participants
        </div>
        <div class="trip-card__section-avatars">
          <% trip.users.each do |user| %>
            <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
              <%= render "shared/avatar", user: user %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="trip-card__animation-placeholder">
         <%= image_tag "itinerary-animation.png", alt: "Itinerary animation", class: "trip-card__animation" %>
      </div>

      <%= render "trips/itinerary_button", trip: trip %>

    <% elsif trip.votes_dont_match? %>
      <%# CAS B : Votes en désaccord - Afficher les 4 sections + bouton Review new suggestions (disabled) %>
      <div class="trip-card__sections">
        <div class="trip-card__section">
          <div class="trip-card__section-title">
            Pending invitations (<%= trip.pending_invitations_count %>)
            <% if trip.pending_invitations_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.pending_invitation_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="trip-card__section">
          <div class="trip-card__section-title">
            Sharing preferences (<%= trip.pending_preferences_count %>)
            <% if trip.pending_preferences_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.pending_preferences_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="trip-card__section">
          <div class="trip-card__section-title">
            Reviewing suggestions (<%= trip.reviewing_suggestions_count %>)
            <% if trip.reviewing_suggestions_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.reviewing_suggestions_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="trip-card__section">
          <div class="trip-card__section-title">
            There yugo (<%= trip.ready_to_go_count %>)
            <% if trip.ready_to_go_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.ready_to_go_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <%= link_to "Review new suggestions", review_suggestions_trip_path(trip), class: "trip-card__button" %>

    <% else %>
      <%# CAS C : Votes en cours ou pas encore de votes - Comportement actuel %>
      <div class="trip-card__sections">
        <div class="trip-card__section">
          <div class="trip-card__section-title">
            Pending invitations (<%= trip.pending_invitations_count %>)
            <% if trip.pending_invitations_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.pending_invitation_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="trip-card__section">
          <div class="trip-card__section-title">
            Sharing preferences (<%= trip.pending_preferences_count %>)
            <% if trip.pending_preferences_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.pending_preferences_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="trip-card__section">
          <div class="trip-card__section-title">
            Reviewing suggestions (<%= trip.reviewing_suggestions_count %>)
            <% if trip.reviewing_suggestions_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.reviewing_suggestions_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="trip-card__section">
          <div class="trip-card__section-title">
            There yugo (<%= trip.ready_to_go_count %>)
            <% if trip.ready_to_go_count > 0 %>
              <div class="trip-card__bell-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 5C10 4.46957 10.2107 3.96086 10.5858 3.58579C10.9609 3.21071 11.4696 3 12 3C12.5304 3 13.0391 3.21071 13.4142 3.58579C13.7893 3.96086 14 4.46957 14 5C15.1484 5.54303 16.1274 6.38833 16.8321 7.4453C17.5367 8.50227 17.9404 9.73107 18 11V14C18.0753 14.6217 18.2954 15.2171 18.6428 15.7381C18.9902 16.2592 19.4551 16.6914 20 17H4C4.54494 16.6914 5.00981 16.2592 5.35719 15.7381C5.70457 15.2171 5.92474 14.6217 6 14V11C6.05956 9.73107 6.4633 8.50227 7.16795 7.4453C7.8726 6.38833 8.85159 5.54303 10 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M9 17V18C9 18.7956 9.31607 19.5587 9.87868 20.1213C10.4413 20.6839 11.2044 21 12 21C12.7956 21 13.5587 20.6839 14.1213 20.1213C14.6839 19.5587 15 18.7956 15 18V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            <% end %>
          </div>
          <div class="trip-card__section-avatars">
            <% trip.ready_to_go_users.each do |user| %>
              <div class="trip-card__avatar" title="<%= user.first_name.presence || user.email %>">
                <%= render "shared/avatar", user: user %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <% creator_pref_form = trip.creator_preferences_form %>
      <% if creator_pref_form.nil? && trip.creator == current_user %>
        <!-- Créateur doit remplir son formulaire -->
        <%= button_to "Share your preferences", fill_preferences_user_trip_status_path(trip.user_trip_statuses.find_by(role: "creator")), method: :get, class: "trip-card__button" %>
      <% elsif trip.all_forms_filled? && trip.recommendations.where(accepted: nil).any? %>
        <%= link_to "Suggestions are ready to review", review_suggestions_trip_path(trip), class: "trip-card__button" %>
      <% else %>
        <%= link_to "Review suggestions", review_suggestions_trip_path(trip), class: "trip-card__button" %>
      <% end %>
    <% end %>
  </div>
</div>
